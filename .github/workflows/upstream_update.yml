name: Upstream update handler

on:
  repository_dispatch:
    types: [upstream_update]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Debug
        run: |
          HELM_ARGS=""
          if [ ${{ github.event.client_payload.upstream_update }} = true ]; then
            UPSTREAM_TAG=${{ github.event.client_payload.upstream_tag }}
            echo "Upstream update was requested. Upstream tag: ${UPSTREAM_TAG}"
            HELM_ARGS+=" \
            --set postanalytics.addnode.image.tag=${UPSTREAM_TAG} \
            --set postanalytics.exportenv.image.tag=${UPSTREAM_TAG} \
            --set postanalytics.cron.image.tag=${UPSTREAM_TAG} \
            --set postanalytics.tarantool.image.tag=${UPSTREAM_TAG} \
            --set postanalytics.heartbeat.image.tag=${UPSTREAM_TAG} \
            --set postanalytics.appstructure.image.tag=${UPSTREAM_TAG}"
            echo "HELM_ARGS: ${HELM_ARGS}"
          fi
          
          if [ ${{ github.event.client_payload.sidecar_update }} = true ]; then
            SIDECAR_TAG=${{ github.event.client_payload.sidecar_tag }}
            echo "Sidecar update was requested. Sidecar tag: ${SIDECAR_TAG}"
            HELM_ARGS+=" --set config.sidecar.image.tag=${SIDECAR_TAG}"
            echo "HELM_ARGS: ${HELM_ARGS}"
          fi
          echo "HELM_ARGS=${HELM_ARGS}" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: 'main'

      - name: Create cluster
        uses: helm/kind-action@v1.3.0
        with:
          verbosity: "0"
          wait: "240s"
          config: helm/test/kind/kind.yaml
          node_image: kindest/node:v1.24.1
          cluster_name: kind

      - name: Wait cluster
        run: |
          kubectl cluster-info
          kubectl wait --for=condition=Ready pods --all --timeout=180s -n kube-system
          echo "current-context:" $(kubectl config current-context)
          echo "environment-kubeconfig:" ${KUBECONFIG}

      - name: Install Helm chart
        run: |
          set -x
          helm version
          helm install wallarm-sidecar helm/. -f helm/values.test.yaml \
          --set config.wallarm.api.host=audit.api.wallarm.com \
          --set config.wallarm.api.token=${{ secrets.API_TOKEN }} \
          ${HELM_ARGS} \
          --namespace wallarm-sidecar \
          --create-namespace \
          --wait \
          --debug \
          --timeout 5m0s
          kubectl -n wallarm-sidecar wait --for=condition=Ready pods --all --timeout=30s
          kubectl -n wallarm-sidecar get all --namespace wallarm-sidecar
          kubectl -n wallarm-sidecar describe pod -l app.kubernetes.io/component=controller
          kubectl -n wallarm-sidecar describe pod -l app.kubernetes.io/component=postanalytics

      - name: Run test
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pytest helm/test/integration_test.py


#  update_versions:
#    name: Update versions
#    needs: test
#    uses: wallarm/sidecar/.github/workflows/update_versions.yaml@main
#    with:
#      controller_update: true
#      controller_tag: ${{ github.ref_name }}